name: Gemini PR Reviewer

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'backend/**'

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR Diff
        id: diff
        run: |
          # backendãƒ•ã‚©ãƒ«ãƒ€å†…ã®å·®åˆ†ã‚’å–å¾—
          git diff origin/${{ github.base_ref }}...HEAD -- 'backend/' > pr_diff.txt
          if [ -s pr_diff.txt ]; then
            echo "has_diff=true" >> $GITHUB_OUTPUT
          else
            echo "has_diff=false" >> $GITHUB_OUTPUT
          fi

      - name: Gemini AI Review
        if: steps.diff.outputs.has_diff == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€JSONã§é€ã‚Œã‚‹ã‚ˆã†ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã‚’ã™ã‚‹
          # Pythonã‚’ä½¿ã£ã¦å®‰å…¨ã«JSONæ–‡å­—åˆ—ã‚’ä½œæˆã—ã¾ã™
          python3 -c "
          import os, json, requests

          diff = open('pr_diff.txt').read()
          api_key = os.getenv('GEMINI_API_KEY')
          pr_number = os.getenv('PR_NUMBER')
          repo = os.getenv('GITHUB_REPOSITORY')
          github_token = os.getenv('GITHUB_TOKEN')

          prompt = f'''ã‚ãªãŸã¯ä¸–ç•Œæœ€é«˜å³°ã® Go ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚
          ãƒãƒƒãƒãƒ³ã‚°ã‚¢ãƒ—ãƒªã€ŒDestiny Faceã€ã® backend ã‚³ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€
          æ”¹å–„ç‚¹ã‚’æ—¥æœ¬èªã§å…·ä½“çš„ã«ï¼ˆBefore/Afterã®ã‚³ãƒ¼ãƒ‰ä»˜ãã§ï¼‰æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚
          
          é‡ç‚¹ï¼šãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ã®éµå®ˆã€DIPã€Goã®å‘½åè¦å‰‡ã€‚

          å·®åˆ†ï¼š
          {diff}'''

          # Gemini APIã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          url = f'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={api_key}'
          payload = {'contents': [{'parts': [{'text': prompt}]}]}
          res = requests.post(url, json=payload)
          review_text = res.json()['candidates'][0]['content']['parts'][0]['text']

          # GitHub PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          comment_url = f'https://api.github.com/repos/{repo}/issues/{pr_number}/comments'
          headers = {'Authorization': f'token {github_token}', 'Content-Type': 'application/json'}
          comment_payload = {'body': f'### ğŸ¤– Gemini ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\n{review_text}'}
          requests.post(comment_url, json=comment_payload, headers=headers)
          "